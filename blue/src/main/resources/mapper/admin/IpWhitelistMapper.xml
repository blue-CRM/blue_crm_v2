<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blue.auth.mapper.IpWhitelistMapper">

    <!-- 로그인 시 사용 -->
    <select id="countActiveByIp" resultType="int">
        SELECT COUNT(*)
        FROM ip_whitelist
        WHERE ip_address = #{ip}
          AND is_active = 'Y'
    </select>

    <!-- 슈퍼 내정보 설정 화면용 -->
    <select id="findAll" resultType="com.blue.auth.dto.IpWhitelistDto">
        SELECT
            ip_id      AS ipId,
            ip_address AS ipAddress,
            memo       AS memo,
            is_active  AS isActive,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM ip_whitelist
        ORDER BY
            COALESCE(updated_at, created_at) DESC,
            ip_id DESC
    </select>

    <insert id="insert"
            parameterType="com.blue.auth.dto.IpWhitelistDto"
            useGeneratedKeys="true"
            keyProperty="ipId">
        INSERT INTO ip_whitelist (
            ip_address, memo, is_active
        ) VALUES (
                     #{ipAddress},
                     #{memo},
                     COALESCE(#{isActive}, 'Y')
                 )
    </insert>

    <update id="update"
            parameterType="com.blue.auth.dto.IpWhitelistDto">
        UPDATE ip_whitelist
        SET
            ip_address = #{ipAddress},
            memo       = #{memo},
            is_active  = #{isActive},
            updated_at = NOW()
        WHERE ip_id = #{ipId}
    </update>

    <!-- 비활성화 (소프트 삭제) -->
    <update id="deactivate">
        UPDATE ip_whitelist
        SET
            is_active  = 'N',
            updated_at = NOW()
        WHERE ip_id = #{ipId}
    </update>

    <!-- 완전 삭제 (하드 삭제) -->
    <delete id="deleteHard">
        DELETE
        FROM ip_whitelist
        WHERE ip_id = #{ipId}
    </delete>

</mapper>
