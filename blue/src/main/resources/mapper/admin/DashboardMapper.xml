<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.blue.dashboard.mapper.DashboardMapper">

    <!-- 지점 목록 -->
    <select id="findBranches" resultType="com.blue.dashboard.dto.BranchDto">
        SELECT
        b.branch_id   AS id,
        b.branch_name AS name
        FROM branches b
        WHERE b.branch_id != 1       <!-- 본사지점 제외 -->
        ORDER BY b.branch_name ASC
    </select>

    <!-- 센터 목록 (본사 제외) -->
    <select id="findCenters" resultType="com.blue.dashboard.dto.CenterDto">
        SELECT
        c.center_id   AS id,
        c.center_name AS name,
        c.branch_id   AS branchId,
        b.branch_name AS branchName
        FROM centers c
        LEFT JOIN branches b ON c.branch_id = b.branch_id
        WHERE c.branch_id != 1       <!-- 본사지점 소속 센터 전체 제외 -->
        ORDER BY
        b.branch_name ASC,
        c.center_name ASC
    </select>

    <!-- 승인 사용자 목록 -->
    <select id="findUsers" resultType="com.blue.dashboard.dto.UserDto">
        SELECT
            u.user_id      AS id,
            u.user_name    AS name,
            u.center_id    AS centerId,
            c.center_name  AS center,
            u.user_role    AS role
        FROM users u
                 LEFT JOIN centers c ON c.center_id = u.center_id
        WHERE u.user_approved = 'Y'
        ORDER BY u.user_created_at DESC
    </select>

    <!-- 정확 일치 검색: 이름 -->
    <select id="findUsersExactByName" parameterType="string" resultType="com.blue.dashboard.dto.UserDto">
        SELECT
            u.user_id      AS id,
            u.user_name    AS name,
            u.center_id    AS centerId,
            c.center_name  AS center,
            u.user_role    AS role
        FROM users u
                 LEFT JOIN centers c ON c.center_id = u.center_id
        WHERE u.user_approved = 'Y'
          AND u.user_name = #{name}
        ORDER BY u.user_created_at DESC
    </select>

    <!-- 정확 일치 검색: 이메일 -->
    <select id="findUsersExactByEmail" parameterType="string" resultType="com.blue.dashboard.dto.UserDto">
        SELECT
            u.user_id      AS id,
            u.user_name    AS name,
            u.center_id    AS centerId,
            c.center_name  AS center,
            u.user_role    AS role
        FROM users u
                 LEFT JOIN centers c ON c.center_id = u.center_id
        WHERE u.user_approved = 'Y'
          AND u.user_email = #{email}
        ORDER BY u.user_created_at DESC
    </select>

    <!-- ────────────────────────────
     개인 통계
    ──────────────────────────── -->
    <!-- 기간 내 합계 -->
    <select id="getUserRangeStats" resultType="com.blue.dashboard.dto.RangeStatsDto">
        SELECT
        COALESCE(SUM(main_count),0) AS mainCount,
        COALESCE(SUM(dup_count),0)  AS dupCount
        FROM user_daily_stats
        WHERE user_id = #{userId}
        <if test="dateFrom != null and dateFrom != ''">
            AND stat_date &gt;= #{dateFrom}
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND stat_date &lt;= #{dateTo}
        </if>
    </select>

    <!-- 전체 기간 합계 -->
    <select id="getUserTotalStats" resultType="com.blue.dashboard.dto.TotalStatsDto">
        SELECT
            COALESCE(SUM(main_count),0) AS mainCount,
            COALESCE(SUM(dup_count),0)  AS dupCount
        FROM user_daily_stats
        WHERE user_id = #{userId}
    </select>

    <!-- ────────────────────────────
         센터 통계
    ──────────────────────────── -->
    <!-- 기간 내 합계 (센터들 여러 개) -->
    <select id="getCenterRangeStats" resultType="com.blue.dashboard.dto.RangeStatsDto">
        SELECT
        COALESCE(SUM(uds.main_count),0) AS mainCount,
        COALESCE(SUM(uds.dup_count),0)  AS dupCount
        FROM user_daily_stats uds
        JOIN users u ON u.user_id = uds.user_id
        WHERE u.center_id IN
        <foreach collection="centerIds" item="cid" open="(" close=")" separator=",">
            #{cid}
        </foreach>
        <if test="dateFrom != null and dateFrom != ''">
            AND uds.stat_date &gt;= #{dateFrom}
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND uds.stat_date &lt;= #{dateTo}
        </if>
    </select>

    <!-- 전체 기간 합계 (센터들 여러 개) -->
    <select id="getCenterTotalStats" resultType="com.blue.dashboard.dto.TotalStatsDto">
        SELECT
        COALESCE(SUM(uds.main_count),0) AS mainCount,
        COALESCE(SUM(uds.dup_count),0)  AS dupCount
        FROM user_daily_stats uds
        JOIN users u ON u.user_id = uds.user_id
        WHERE u.center_id IN
        <foreach collection="list" item="cid" open="(" close=")" separator=",">
            #{cid}
        </foreach>
    </select>

    <!-- 센터들에 속한 직원 수 (MANAGER+STAFF) -->
    <select id="countUsersInCenters" resultType="int">
        SELECT COUNT(*)
        FROM users
        WHERE center_id IN
        <foreach collection="list" item="cid" open="(" close=")" separator=",">
            #{cid}
        </foreach>
        AND user_role IN ('MANAGER','STAFF')
    </select>

    <!-- ────────────────────────────
         지점 통계
    ──────────────────────────── -->
    <!-- 기간 내 합계 (지점 여러 개) -->
    <select id="getBranchRangeStats" resultType="com.blue.dashboard.dto.RangeStatsDto">
        SELECT
        COALESCE(SUM(uds.main_count),0) AS mainCount,
        COALESCE(SUM(uds.dup_count),0)  AS dupCount
        FROM user_daily_stats uds
        JOIN users   u ON u.user_id = uds.user_id
        JOIN centers c ON c.center_id = u.center_id
        WHERE c.branch_id IN
        <foreach collection="branchIds" item="bid" open="(" close=")" separator=",">
            #{bid}
        </foreach>
        <if test="dateFrom != null and dateFrom != ''">
            AND uds.stat_date &gt;= #{dateFrom}
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND uds.stat_date &lt;= #{dateTo}
        </if>
    </select>

    <!-- 전체 기간 합계 (지점 여러 개) -->
    <select id="getBranchTotalStats" resultType="com.blue.dashboard.dto.TotalStatsDto">
        SELECT
        COALESCE(SUM(uds.main_count),0) AS mainCount,
        COALESCE(SUM(uds.dup_count),0)  AS dupCount
        FROM user_daily_stats uds
        JOIN users   u ON u.user_id = uds.user_id
        JOIN centers c ON c.center_id = u.center_id
        WHERE c.branch_id IN
        <foreach collection="list" item="bid" open="(" close=")" separator=",">
            #{bid}
        </foreach>
    </select>

    <!-- 지점에 속한 직원 수 -->
    <select id="countUsersInBranches" resultType="int">
        SELECT COUNT(*)
        FROM users u
        JOIN centers c ON c.center_id = u.center_id
        WHERE c.branch_id IN
        <foreach collection="list" item="bid" open="(" close=")" separator=",">
            #{bid}
        </foreach>
        AND u.user_role IN ('MANAGER','STAFF')
    </select>

    <!-- KPI: 승인 사용자 수 -->
    <select id="countApprovedUsers" resultType="int">
        SELECT COUNT(*) FROM users WHERE user_approved = 'Y'
    </select>

    <!-- KPI: 센터 수 (본사지점 소속 제외) -->
    <select id="countCentersExcludingHQ" resultType="int">
        SELECT COUNT(*)
        FROM centers
        WHERE branch_id != 1
    </select>

    <!-- KPI: 지점 수 (본사지점 제외) -->
    <select id="countBranchesExcludingHQ" resultType="int">
        SELECT COUNT(*)
        FROM branches
        WHERE branch_id != 1
    </select>

</mapper>