<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blue.customer.allocate.mapper.CustomerAllocateMapper">

    <!-- 로그인 사용자 컨텍스트 -->
    <select id="findUserContextByEmail" resultType="com.blue.customer.allocate.dto.UserContextDto">
        SELECT
            u.user_id    AS userId,
            u.user_role  AS role,
            u.center_id  AS centerId,
            u.user_email AS email,
            u.manager_phone_access AS visible,
            u.can_allocate AS canAllocate,
            u.expert_id    AS expertId
        FROM users u
        WHERE u.user_email = #{email}
        LIMIT 1
    </select>

    <!-- 공통 필터 -->
    <sql id="LIST_FILTERS_COMMON">
        <if test="keyword != null and keyword != ''">
            <choose>
                <!-- 가시권한 N: 이름 LIKE + 앞3/앞2/뒤4 '정확일치'만 -->
                <when test='visible == "N"'>
                    AND (
                    c.customer_name LIKE CONCAT('%', #{keyword}, '%')
                    OR RIGHT(REPLACE(c.customer_phone, '-', ''), 4) = REPLACE(#{keyword}, '-', '')
                    OR LEFT(REPLACE(c.customer_phone,  '-', ''), 3) = REPLACE(#{keyword}, '-', '')
                    OR LEFT(REPLACE(c.customer_phone,  '-', ''), 2) = REPLACE(#{keyword}, '-', '')
                    )
                </when>
                <!-- 기본: 이름/전화 LIKE -->
                <otherwise>
                    AND (
                    c.customer_name   LIKE CONCAT('%', #{keyword}, '%')
                    OR c.customer_phone LIKE CONCAT('%', #{keyword}, '%')
                    OR EXISTS (
                        SELECT 1
                        FROM customer_past_users cpu
                        JOIN users u_past ON u_past.user_id = cpu.user_id
                        WHERE cpu.customer_phone = c.customer_phone
                        AND u_past.user_name LIKE CONCAT('%', #{keyword}, '%')
                    )
                    )
                </otherwise>
            </choose>
        </if>
        <if test="dateFrom != null and dateFrom != ''">
            AND c.customer_created_at &gt;= #{dateFrom}
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND c.customer_created_at &lt; DATE_ADD(#{dateTo}, INTERVAL 1 DAY)
        </if>
        <if test="category != null and category != ''">
            AND c.customer_category = #{category}
        </if>
        <if test="prevStatus != null and prevStatus != ''">
            AND c.customer_prev_status = #{prevStatus}
        </if>
    </sql>

    <sql id="ORDER_DEFAULT">
        <choose>
            <when test="sort == 'status'">
                ORDER BY FIELD(c.customer_status,'회수','없음','신규','가망','재콜','내방','내방취소','부재1','부재2','부재3','부재4','부재5','기타','결번','거절','자연풀','카피'),
                c.customer_created_at DESC
            </when>
            <when test="sort == 'oldest'">
                ORDER BY c.customer_created_at ASC
            </when>
            <otherwise>
                ORDER BY c.customer_created_at DESC
            </otherwise>
        </choose>
    </sql>

    <!-- ================= HQ 목록: 프로 없음 + 상태 ∈ {없음, 회수} ================= -->
    <select id="findListForHq" resultType="com.blue.customer.allocate.dto.AllocateListRowDto">
        SELECT
            c.customer_id           AS id,
            c.customer_name         AS name,

            CASE WHEN #{visible} = 'Y'
            THEN c.customer_phone
            ELSE CONCAT(SUBSTRING_INDEX(c.customer_phone,'-',1), '-****-', SUBSTRING_INDEX(c.customer_phone,'-',-1))
            END AS phone,

            IFNULL((
                SELECT GROUP_CONCAT(
                    u2.user_name
                    ORDER BY cpu.past_user_id
                    SEPARATOR ', '
                )

                FROM customer_past_users cpu
                JOIN users u2 ON u2.user_id = cpu.user_id
                WHERE cpu.customer_phone = c.customer_phone
            ), '') AS paststaff,

            u.user_name             AS staff,
            c.customer_division     AS division,
            c.customer_category     AS category,
            c.customer_status       AS status,
            c.customer_prev_status  AS prevStatus,
            ctr.center_name         AS centerName,
            c.customer_source       AS source,
            c.customer_content      AS content,
            c.customer_created_at   AS createdAt
        FROM customers c
        LEFT JOIN users u   ON u.user_id = c.user_id
        LEFT JOIN centers ctr ON ctr.center_id = u.center_id

        WHERE c.user_id IS NULL
          AND c.customer_status IN ('없음','회수')

        <if test="division != null and division != ''">
            AND c.customer_division = #{division}
        </if>
        <include refid="LIST_FILTERS_COMMON"/>
        <include refid="ORDER_DEFAULT"/>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countListForHq" resultType="int">
        SELECT COUNT(*)
        FROM customers c
        LEFT JOIN users u ON u.user_id = c.user_id

        WHERE c.user_id IS NULL
            AND c.customer_status IN ('없음','회수')

        <if test="division != null and division != ''">
            AND c.customer_division = #{division}
        </if>
        <include refid="LIST_FILTERS_COMMON"/>
    </select>

    <!-- ============== MANAGER 목록: 담당 프로=나 + 상태='없음' ============== -->
    <select id="findListForManager" resultType="com.blue.customer.allocate.dto.AllocateListRowDto">
        SELECT
            c.customer_id           AS id,
            c.customer_name         AS name,
            c.customer_phone        AS phone,

            IFNULL((
            SELECT GROUP_CONCAT(u2.user_name ORDER BY cpu.past_user_id SEPARATOR ', ')
            FROM customer_past_users cpu
            JOIN users u2 ON u2.user_id = cpu.user_id
            WHERE cpu.customer_phone = c.customer_phone
            ), '') AS paststaff,

            c.customer_division     AS division,
            c.customer_category     AS category,
            c.customer_status       AS status,
            c.customer_prev_status  AS prevStatus,
            (SELECT center_name FROM centers WHERE center_id = u.center_id) AS centerName,
            c.customer_source       AS source,
            c.customer_content      AS content,
            c.customer_created_at   AS createdAt
        FROM customers c
        JOIN users u ON u.user_id = c.user_id

        WHERE c.user_id = #{managerUserId}
            AND c.customer_status = '없음'

        <include refid="LIST_FILTERS_COMMON"/>
        <include refid="ORDER_DEFAULT"/>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countListForManager" resultType="int">
        SELECT COUNT(*)
        FROM customers c
        JOIN users u ON u.user_id = c.user_id

        WHERE c.user_id = #{managerUserId}
            AND c.customer_status = '없음'

        <include refid="LIST_FILTERS_COMMON"/>
    </select>

    <!-- ============== CENTERHEAD 목록 조회 ============== -->
    <select id="findListForCenterHead" resultType="com.blue.customer.allocate.dto.AllocateListRowDto">
        SELECT
        c.customer_id           AS id,
        c.customer_name         AS name,

        CASE WHEN #{visible} = 'Y'
        THEN c.customer_phone
        ELSE CONCAT(SUBSTRING_INDEX(c.customer_phone,'-',1), '-****-', SUBSTRING_INDEX(c.customer_phone,'-',-1))
        END AS phone,

        IFNULL((
        SELECT GROUP_CONCAT(
        u2.user_name
        ORDER BY cpu.past_user_id
        SEPARATOR ', '
        )
        FROM customer_past_users cpu
        JOIN users u2 ON u2.user_id = cpu.user_id
        WHERE cpu.customer_phone = c.customer_phone
        ), '') AS paststaff,

        u.user_name             AS staff,
        c.customer_division     AS division,
        c.customer_category     AS category,
        c.customer_status       AS status,
        c.customer_prev_status  AS prevStatus,
        ctr.center_name         AS centerName,
        c.customer_source       AS source,
        c.customer_content      AS content,
        c.customer_created_at   AS createdAt
        FROM customers c
        LEFT JOIN users u   ON u.user_id = c.user_id
        LEFT JOIN centers ctr ON ctr.center_id = u.center_id

        WHERE c.user_id IS NULL AND c.customer_status IN ('없음','회수')

        <if test="division != null and division != ''">
            AND c.customer_division = #{division}
        </if>

          AND c.customer_source IN (
        SELECT e.expert_name
        FROM users team_user
        JOIN experts e ON e.expert_id = team_user.expert_id
        WHERE team_user.center_id = #{centerId}
        )

        <include refid="LIST_FILTERS_COMMON"/>
        <include refid="ORDER_DEFAULT"/>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countListForCenterHead" resultType="int">
        SELECT COUNT(*)
        FROM customers c
        LEFT JOIN users u ON u.user_id = c.user_id
        WHERE c.user_id IS NULL AND c.customer_status IN ('없음','회수')

        <if test="division != null and division != ''">
            AND c.customer_division = #{division}
        </if>

        AND c.customer_source IN (
        SELECT e.expert_name
        FROM users team_user
        JOIN experts e ON e.expert_id = team_user.expert_id
        WHERE team_user.center_id = #{centerId}
        )
        <include refid="LIST_FILTERS_COMMON"/>
    </select>

    <!-- ============== EXPERT 목록 조회 ============== -->
    <select id="findListForExpert" resultType="com.blue.customer.allocate.dto.AllocateListRowDto">
        SELECT
        c.customer_id           AS id,
        c.customer_name         AS name,

        CASE WHEN #{visible} = 'Y'
        THEN c.customer_phone
        ELSE CONCAT(SUBSTRING_INDEX(c.customer_phone,'-',1), '-****-', SUBSTRING_INDEX(c.customer_phone,'-',-1))
        END AS phone,

        IFNULL((
        SELECT GROUP_CONCAT(
        u2.user_name
        ORDER BY cpu.past_user_id
        SEPARATOR ', '
        )
        FROM customer_past_users cpu
        JOIN users u2 ON u2.user_id = cpu.user_id
        WHERE cpu.customer_phone = c.customer_phone
        ), '') AS paststaff,

        u.user_name             AS staff,
        c.customer_division     AS division,
        c.customer_category     AS category,
        c.customer_status       AS status,
        c.customer_prev_status  AS prevStatus,
        ctr.center_name         AS centerName,
        c.customer_source       AS source,
        c.customer_content      AS content,
        c.customer_created_at   AS createdAt
        FROM customers c
        LEFT JOIN users u   ON u.user_id = c.user_id
        LEFT JOIN centers ctr ON ctr.center_id = u.center_id

        WHERE c.user_id IS NULL AND c.customer_status IN ('없음','회수')

        <if test="division != null and division != ''">
            AND c.customer_division = #{division}
        </if>

          AND c.customer_source = (
        SELECT expert_name
        FROM experts
        WHERE expert_id = #{expertId}
        )

        <include refid="LIST_FILTERS_COMMON"/>
        <include refid="ORDER_DEFAULT"/>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countListForExpert" resultType="int">
        SELECT COUNT(*)
        FROM customers c
        LEFT JOIN users u ON u.user_id = c.user_id
        WHERE c.user_id IS NULL AND c.customer_status IN ('없음','회수')

        <if test="division != null and division != ''">
            AND c.customer_division = #{division}
        </if>

          AND c.customer_source = (
        SELECT expert_name
        FROM experts
        WHERE expert_id = #{expertId}
        )
        <include refid="LIST_FILTERS_COMMON"/>
    </select>

    <!-- 검증/조회 -->
    <select id="userBelongsToCenter" resultType="int">
        SELECT COUNT(*)
        FROM users
        WHERE user_id = #{userId}
          AND center_id = #{centerId}
    </select>

    <!-- HQ가 대상 역할 판별 -->
    <select id="findUserRole" resultType="string">
        SELECT user_role FROM users WHERE user_id = #{userId} LIMIT 1
    </select>

    <!-- 같은 팀 여부 (팀장 자기자신 허용) -->
    <select id="staffInSameCenter" resultType="int">
        SELECT COUNT(*)
        FROM users s
        JOIN users m ON m.user_id = #{managerUserId}
        WHERE s.user_id   = #{staffUserId}
            AND s.center_id = m.center_id
            AND (s.user_role = 'STAFF' OR s.user_id = m.user_id)
            AND s.user_approved = 'Y'                <!-- 승인된 직원만 허용 -->
    </select>

    <!-- 잠금: HQ 대상 (프로 없음 + 상태 없음/회수) -->
    <select id="lockCustomersForHq" resultType="long">
        SELECT c.customer_id
        FROM customers c

        WHERE c.customer_id IN
            <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
        AND c.user_id IS NULL
        AND c.customer_status IN ('없음','회수')

        FOR UPDATE
    </select>

    <!-- 잠금: MANAGER 대상 (현재담당=팀장 본인 + 상태=없음) -->
    <select id="lockCustomersForManager" resultType="long">
        SELECT c.customer_id
        FROM customers c
        WHERE c.customer_id IN
            <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
        AND c.user_id = #{managerUserId}
        AND c.customer_status = '없음'
        FOR UPDATE
    </select>

    <!-- 잠금: CENTERHEAD 대상 -->
    <select id="lockCustomersForCenterHead" resultType="long">
        SELECT c.customer_id
        FROM customers c
        WHERE c.customer_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>

        AND c.user_id IS NULL
        AND c.customer_status IN ('없음', '회수')

        AND c.customer_source IN (
        SELECT e.expert_name
        FROM users team_user
        JOIN experts e ON e.expert_id = team_user.expert_id
        WHERE team_user.center_id = #{centerId}
        )
        FOR UPDATE
    </select>

    <!-- 잠금: EXPERT 대상 -->
    <select id="lockCustomersForExpert" resultType="long">
        SELECT c.customer_id
        FROM customers c
        WHERE c.customer_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>

        AND c.user_id IS NULL
        AND c.customer_status IN ('없음', '회수')

        AND c.customer_source = (
        SELECT expert_name
        FROM experts
        WHERE expert_id = #{expertId}
        )
        FOR UPDATE
    </select>

    <!-- 이력 적재: 새로 배정받는 사람(팀장/직원) -->
    <insert id="insertPastForNewOwner">
        INSERT INTO customer_past_users (customer_phone, user_id)
        SELECT c.customer_phone, #{userId}
        FROM customers c
        WHERE c.customer_id IN
            <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
        AND NOT EXISTS (
            SELECT 1 FROM customer_past_users cpu
            WHERE cpu.customer_phone = c.customer_phone
                AND cpu.user_id = #{userId}
        )
    </insert>

    <!-- 예외: 팀장→직원 재분배 시, 팀장 이력 삭제 -->
    <delete id="deleteManagerFromPast">
        DELETE cpu
        FROM customer_past_users cpu
        JOIN customers c ON c.customer_phone = cpu.customer_phone
        WHERE cpu.user_id = #{managerUserId}
        AND c.customer_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
    </delete>

    <!-- 소유자/상태 변경 -->
    <update id="updateOwner">
        UPDATE customers
        SET user_id = #{userId}
        WHERE customer_id IN
            <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
    </update>

    <!-- 상태 '신규'로 통일 (HQ→직원, 팀장→본인/직원) -->
    <!-- 단, 직전상태가 '내방'일 경우 현재상태 '내방'으로 고정 -->
    <update id="updateStatusToNew">
        UPDATE customers c
        LEFT JOIN visit_schedule vs ON vs.customer_id = c.customer_id
        SET
        c.customer_status =
            CASE
                WHEN c.customer_prev_status = '내방' THEN '내방'
                ELSE '신규'
            END,
        vs.scheduled_by_user_id =
            CASE
                WHEN c.customer_prev_status = '내방' THEN c.user_id
                ELSE vs.scheduled_by_user_id
            END
        WHERE c.customer_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
    </update>

    <!-- 본사에서 팀장 분배시: '없음'으로 통일 -->
    <update id="updateStatusToNone">
        UPDATE customers
        SET customer_status = '없음'
        WHERE customer_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
    </update>

    <!-- 직원 검색: 같은 팀의 MANAGER/STAFF 모두 (팀장 자기자신 선택 가능) -->
    <select id="searchStaffForAllocate" resultType="com.blue.customer.allocate.dto.UserPickDto">
        SELECT
        u.user_id     AS userId,
        u.user_name   AS userName,
        c.center_name AS centerName,
        u.user_role   AS role
        FROM users u
        LEFT JOIN centers c ON c.center_id = u.center_id
        WHERE u.user_role IN ('MANAGER','STAFF')
            AND u.user_approved = 'Y'                <!-- 승인된 직원만 -->
        <if test="centerId != null">
            AND u.center_id = #{centerId}
        </if>
        <if test="q != null and q != ''">
            AND (
            u.user_name LIKE CONCAT('%', #{q}, '%')
            OR REPLACE(SUBSTRING_INDEX(u.user_phone, '-', -1), '-', '') LIKE REPLACE(#{q}, '-', '')
            )
        </if>
        ORDER BY FIELD(u.user_role, 'MANAGER','STAFF'), u.user_name ASC, u.user_id ASC
    </select>

    <!-- 분배용 팀 목록:
      1) 사람 0명인 팀 제외
      2) 본사지점(branch_id == 1) 인 경우 제외 -> 어차피 센터장/전문가/관리자라 분배받을 대상이 아님
      3) hasManager 플래그/인원수 내려줌 -->
    <select id="findCentersForAllocate" resultType="com.blue.customer.allocate.dto.CenterPickDto">
        SELECT
        c.center_id   AS centerId,
        c.center_name AS centerName,
        EXISTS(
            SELECT 1
            FROM users mu
            WHERE mu.center_id = c.center_id
                AND mu.user_role = 'MANAGER'
                AND mu.user_approved = 'Y'           <!-- 승인된 팀장만 hasManager -->
        ) AS hasManager,
        (
            SELECT COUNT(*)
            FROM users u
            WHERE u.center_id = c.center_id
                AND u.user_approved = 'Y'            <!-- 승인된 인원만 카운트 -->
        ) AS userCount
            FROM centers c
            WHERE (c.branch_id IS NULL OR c.branch_id != 1) <!-- 본사지점 제외 -->
                AND EXISTS (                              <!-- 승인된 인원 1명 이상 있는 팀만 노출 -->
                    SELECT 1 FROM users u
                    WHERE u.center_id = c.center_id
                    AND u.user_approved = 'Y'
                )
            ORDER BY c.center_name ASC
    </select>

    <!-- 담당자 이력 일괄 초기화 -->
    <delete id="deleteHistoryByCustomerIds">
        DELETE cpu
        FROM customer_past_users cpu

        -- 1) 현재 담당자인 customers 와 LEFT JOIN
        LEFT JOIN customers cur
        ON cur.customer_phone = cpu.customer_phone
        AND cur.user_id        = cpu.user_id   -- 이 번호를 지금 맡고 있는지
        WHERE cpu.customer_phone IN (
        SELECT DISTINCT c.customer_phone
        FROM customers c
        WHERE c.customer_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        )
        -- 2) 현재 담당자인 customers 가 하나도 없을 때만 이력 삭제
        AND cur.customer_id IS NULL;
    </delete>

    <!-- 모달에서 : 담당자 이력 리스트 조회 -->
    <select id="findHistoryByCustomerId"
            resultType="com.blue.customer.allocate.dto.CustomerHistoryRowDto">
        SELECT
            cpu.past_user_id            AS logId,
            u.user_name                 AS userName,

            -- 최근에 이 담당자에게 배정됐던 고객 이름
            (
                SELECT c2.customer_name
                FROM customers c2
                WHERE c2.customer_phone = cpu.customer_phone
                  AND c2.user_id        = cpu.user_id
                ORDER BY c2.customer_created_at DESC
                LIMIT 1
            )                AS customerName,

            -- 최근 배정 시각: 분배로그 기준
            COALESCE(
                    (
                        SELECT c3.customer_created_at
                        FROM alloc_logs l
                                 JOIN customers c3 ON c3.customer_id = l.customer_id
                        WHERE c3.customer_phone = cpu.customer_phone   -- 같은 전화번호 묶음
                          AND l.to_user_id      = cpu.user_id          -- 이 담당자에게
                          AND l.action_type     = 'ASSIGN'
                          AND l.is_final_assign = 1                    -- 확정 분배만
                        ORDER BY l.action_at DESC                      -- 가장 마지막에 행해진 분배
                        LIMIT 1                                        -- 그 분배 대상의 생성일만 가져오기
                    ),
                    -- 로그가 없던 시절 데이터 fallback: 기존 로직
                    (
                        SELECT MAX(c2.customer_created_at)
                        FROM customers c2
                        WHERE c2.customer_phone = cpu.customer_phone
                          AND c2.user_id        = cpu.user_id
                    )
            ) AS assignedAt,

            -- 현재담당자 여부 판단
            CASE
                WHEN EXISTS (
                    SELECT 1
                    FROM customers cur
                    WHERE cur.customer_phone = cpu.customer_phone
                      AND cur.user_id = cpu.user_id
                ) THEN TRUE ELSE FALSE
                END                          AS isCurrent,


            -- 팀장 풀 여부: MANAGER + 상태 '없음'
            CASE
                WHEN u.user_role = 'MANAGER'
                    AND NOT EXISTS (
                        SELECT 1
                        FROM customers cur
                        WHERE cur.customer_phone = cpu.customer_phone
                          AND cur.user_id        = cpu.user_id
                          AND cur.customer_status != '없음'   -- 해당 전화번호에 대해 확정 분배 DB가 단 1개라도 있으면 팀장풀이 아님
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM customers cur
                        WHERE cur.customer_phone = cpu.customer_phone
                          AND cur.user_id        = cpu.user_id
                          AND cur.customer_status = '없음'    -- 해당 전화번호에 대해 팀장풀 DB가 최소 1개는 있어야 함
                    )
                    THEN TRUE ELSE FALSE
                END AS isManagerPool

        FROM customers c
                 JOIN customer_past_users cpu
                      ON cpu.customer_phone = c.customer_phone
                 JOIN users u
                      ON u.user_id = cpu.user_id
        WHERE c.customer_id = #{customerId}
        GROUP BY cpu.past_user_id, u.user_name
        ORDER BY isCurrent DESC, assignedAt DESC, cpu.past_user_id DESC
    </select>

    <!-- 모달에서 : 담당자 이력 선택 삭제 -->
    <delete id="deleteHistorySafely">
        DELETE cpu
        FROM customer_past_users cpu
        LEFT JOIN customers cur
        ON cur.customer_phone = cpu.customer_phone
        AND cur.user_id        = cpu.user_id
        WHERE cpu.past_user_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND cur.customer_id IS NULL
    </delete>

</mapper>
