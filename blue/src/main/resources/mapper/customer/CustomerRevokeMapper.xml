<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blue.customer.revoke.mapper.CustomerRevokeMapper">

    <!-- 로그인 사용자 컨텍스트 -->
    <select id="findUserContextByEmail" resultType="com.blue.customer.revoke.dto.UserContextDto">
        SELECT
            u.user_id    AS userId,
            u.user_role  AS role,
            u.center_id  AS centerId,
            u.expert_id  AS expertId,
            u.user_email AS email,
            u.can_allocate AS canAllocate,
            u.manager_phone_access AS visible
        FROM users u
        WHERE u.user_email = #{email}
        LIMIT 1
    </select>

    <!-- 공통 필터 -->
    <sql id="LIST_FILTERS_COMMON">
        <if test="keyword != null and keyword != ''">
            <choose>
                <when test='visible == "N"'>
                    AND (
                    c.customer_name LIKE CONCAT('%', #{keyword}, '%')
                    OR u.user_name LIKE CONCAT('%', #{keyword}, '%')
                    OR RIGHT(REPLACE(c.customer_phone, '-', ''), 4) = REPLACE(#{keyword}, '-', '')
                    OR LEFT(REPLACE(c.customer_phone,  '-', ''), 3) = REPLACE(#{keyword}, '-', '')
                    OR LEFT(REPLACE(c.customer_phone,  '-', ''), 2) = REPLACE(#{keyword}, '-', '')
                    )
                </when>
                <otherwise>
                    AND (
                    c.customer_name   LIKE CONCAT('%', #{keyword}, '%')
                    OR u.user_name LIKE CONCAT('%', #{keyword}, '%')
                    OR c.customer_phone LIKE CONCAT('%', #{keyword}, '%')
                    )
                </otherwise>
            </choose>
        </if>
        <if test="dateFrom != null and dateFrom != ''">
            AND c.customer_created_at &gt;= #{dateFrom}
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND c.customer_created_at &lt; DATE_ADD(#{dateTo}, INTERVAL 1 DAY)
        </if>
        <if test="category != null and category != ''">
            AND c.customer_category = #{category}
        </if>
        <if test="status != null and status != ''">
            AND c.customer_status = #{status}
        </if>
    </sql>

    <sql id="ORDER_DEFAULT">
        <choose>
            <when test="sort == 'status'">
                ORDER BY FIELD(c.customer_status,'회수','없음','신규','가망','재콜','내방','내방취소','부재1','부재2','부재3','부재4','부재5','기타','결번','거절','자연풀','카피'),
                c.customer_created_at DESC
            </when>
            <when test="sort == 'oldest'">
                ORDER BY c.customer_created_at ASC
            </when>
            <otherwise>
                ORDER BY c.customer_created_at DESC
            </otherwise>
        </choose>
    </sql>

    <!-- HQ 목록: 프로가 있는 건 + '회수'가 아닌 건 -->
    <select id="findListForHq" resultType="com.blue.customer.revoke.dto.RevokeListRowDto">
        SELECT
        c.customer_id         AS id,
        c.customer_name       AS name,

        CASE WHEN #{visible} = 'Y'
        THEN c.customer_phone
        ELSE CONCAT(SUBSTRING_INDEX(c.customer_phone,'-',1), '-****-', SUBSTRING_INDEX(c.customer_phone,'-',-1))
        END                   AS phone,

        CASE
        WHEN c.customer_status != '없음' THEN u.user_name
        ELSE ''
        END AS staff,

        c.customer_division   AS division,
        c.customer_category   AS category,
        c.customer_status     AS status,
        ctr.center_name       AS centerName,
        c.customer_source     AS source,
        c.customer_content    AS content,
        c.customer_created_at AS createdAt
        FROM customers c
        LEFT JOIN users   u   ON u.user_id   = c.user_id
        LEFT JOIN centers ctr ON ctr.center_id = u.center_id

        WHERE c.customer_status != '회수'
            AND c.user_id IS NOT NULL

        <if test="division != null and division != ''">
            AND c.customer_division = #{division}
        </if>
        <include refid="LIST_FILTERS_COMMON"/>
        <include refid="ORDER_DEFAULT"/>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countListForHq" resultType="int">
        SELECT COUNT(*)
        FROM customers c
        LEFT JOIN users u ON u.user_id = c.user_id

        WHERE c.customer_status != '회수'
            AND c.user_id IS NOT NULL

        <if test="division != null and division != ''">
            AND c.customer_division = #{division}
        </if>
        <include refid="LIST_FILTERS_COMMON"/>
    </select>

    <!-- MANAGER 목록: 같은 팀의 프로가 보유 + '회수'가 아닌 건 -->
    <select id="findListForManager" resultType="com.blue.customer.revoke.dto.RevokeListRowDto">
        SELECT
        c.customer_id         AS id,
        c.customer_name       AS name,
        c.customer_phone      AS phone,

        CASE
        WHEN c.customer_status != '없음' THEN u.user_name
        ELSE ''
        END AS staff,

        c.customer_division   AS division,
        c.customer_category   AS category,
        c.customer_status     AS status,
        (SELECT center_name FROM centers WHERE center_id = u.center_id) AS centerName,
        c.customer_source     AS source,
        c.customer_content    AS content,
        c.customer_created_at AS createdAt
        FROM customers c
        JOIN users u ON u.user_id = c.user_id

        WHERE c.customer_status != '회수'
            AND c.user_id IS NOT NULL
            AND u.center_id = #{managerCenterId}

        <include refid="LIST_FILTERS_COMMON"/>
        <include refid="ORDER_DEFAULT"/>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countListForManager" resultType="int">
        SELECT COUNT(*)
        FROM customers c
        JOIN users u ON u.user_id = c.user_id

        WHERE c.customer_status != '회수'
            AND c.user_id IS NOT NULL
            AND u.center_id = #{managerCenterId}

        <include refid="LIST_FILTERS_COMMON"/>
    </select>

    <!-- CENTERHEAD 목록 -->
    <select id="findListForCenterHead" resultType="com.blue.customer.revoke.dto.RevokeListRowDto">
        SELECT
        c.customer_id         AS id,
        c.customer_name       AS name,

        CASE WHEN #{visible} = 'Y'
        THEN c.customer_phone
        ELSE CONCAT(SUBSTRING_INDEX(c.customer_phone,'-',1), '-****-', SUBSTRING_INDEX(c.customer_phone,'-',-1))
        END                   AS phone,

        CASE
        WHEN c.customer_status != '없음' THEN u.user_name
        ELSE ''
        END AS staff,

        c.customer_division   AS division,
        c.customer_category   AS category,
        c.customer_status     AS status,
        (SELECT center_name FROM centers WHERE center_id = u.center_id) AS centerName,
        c.customer_source     AS source,
        c.customer_content    AS content,
        c.customer_created_at AS createdAt
        FROM customers c
        JOIN users u ON u.user_id = c.user_id

        WHERE c.customer_status != '회수'
        AND c.user_id IS NOT NULL

        AND EXISTS (
        SELECT 1
        FROM users ux
        JOIN experts e ON e.expert_id = ux.expert_id
        WHERE ux.center_id = #{centerId}
        AND ux.user_role IN ('CENTERHEAD','EXPERT')
        AND ux.expert_id IS NOT NULL
        AND TRIM(e.expert_name) = TRIM(c.customer_source)
        )

        <include refid="LIST_FILTERS_COMMON"/>
        <include refid="ORDER_DEFAULT"/>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countListForCenterHead" resultType="int">
        SELECT COUNT(*)
        FROM customers c
        JOIN users u ON u.user_id = c.user_id
        WHERE c.customer_status != '회수'
        AND c.user_id IS NOT NULL

        <!-- 센터 소속 전문가들의 소스만 -->
        AND EXISTS (
        SELECT 1
        FROM users ux
        JOIN experts e ON e.expert_id = ux.expert_id
        WHERE ux.center_id = #{centerId}
        AND ux.user_role IN ('CENTERHEAD','EXPERT')
        AND ux.expert_id IS NOT NULL
        AND TRIM(e.expert_name) = TRIM(c.customer_source)
        )

        <include refid="LIST_FILTERS_COMMON"/>
    </select>

    <!-- EXPERT 목록 -->
    <select id="findListForExpert" resultType="com.blue.customer.revoke.dto.RevokeListRowDto">
        SELECT
        c.customer_id         AS id,
        c.customer_name       AS name,

        CASE WHEN #{visible} = 'Y'
        THEN c.customer_phone
        ELSE CONCAT(SUBSTRING_INDEX(c.customer_phone,'-',1), '-****-', SUBSTRING_INDEX(c.customer_phone,'-',-1))
        END                   AS phone,

        CASE
        WHEN c.customer_status != '없음' THEN u.user_name
        ELSE ''
        END AS staff,

        c.customer_division   AS division,
        c.customer_category   AS category,
        c.customer_status     AS status,
        (SELECT center_name FROM centers WHERE center_id = u.center_id) AS centerName,
        c.customer_source     AS source,
        c.customer_content    AS content,
        c.customer_created_at AS createdAt
        FROM customers c
        JOIN users u ON u.user_id = c.user_id
        JOIN experts me ON me.expert_id = #{expertId}

        WHERE c.customer_status != '회수'
        AND c.user_id IS NOT NULL

        <!-- 전문가 스코프는 '내 전문가명 = 고객 source' -->
        AND TRIM(me.expert_name) = TRIM(c.customer_source)

        <include refid="LIST_FILTERS_COMMON"/>
        <include refid="ORDER_DEFAULT"/>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countListForExpert" resultType="int">
        SELECT COUNT(*)
        FROM customers c
        JOIN users u ON u.user_id = c.user_id
        JOIN experts me ON me.expert_id = #{expertId}
        WHERE c.customer_status != '회수'
        AND c.user_id IS NOT NULL
        AND TRIM(me.expert_name) = TRIM(c.customer_source)
        <include refid="LIST_FILTERS_COMMON"/>
    </select>

    <!-- 회수 잠금(HQ): 프로 있음 + '회수'가 아님 -->
    <select id="lockCustomersForRevokeByHq" resultType="long">
      SELECT c.customer_id
      FROM customers c
      WHERE c.customer_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
        AND c.customer_status != '회수'
        AND c.user_id IS NOT NULL
      FOR UPDATE
    </select>

    <!-- 회수 잠금(MANAGER): 같은 팀 소속 프로의 건 + '회수'가 아님 -->
    <select id="lockCustomersForRevokeByManager" resultType="long">
      SELECT c.customer_id
      FROM customers c
      WHERE c.customer_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
        AND c.customer_status != '회수'
        AND c.user_id IS NOT NULL
        AND EXISTS (
          SELECT 1
          FROM users u
          WHERE u.user_id = c.user_id
            AND u.center_id = #{managerCenterId}
        )

      FOR UPDATE
    </select>

    <!-- 회수 잠금(CENTERHEAD) -->
    <select id="lockCustomersForRevokeByCenterHead" resultType="long">
        SELECT c.customer_id
        FROM customers c
        JOIN users u ON u.user_id = c.user_id
        WHERE c.customer_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
        AND c.customer_status != '회수'
        AND c.user_id IS NOT NULL

        <!-- 주석: 센터장 소스 스코프 -->
        AND EXISTS (
        SELECT 1
        FROM users ux
        JOIN experts e ON e.expert_id = ux.expert_id
        WHERE ux.center_id = #{centerId}
        AND ux.user_role IN ('CENTERHEAD','EXPERT')
        AND ux.expert_id IS NOT NULL
        AND TRIM(e.expert_name) = TRIM(c.customer_source)
        )
        FOR UPDATE
    </select>

    <!-- 회수 잠금(EXPERT) -->
    <select id="lockCustomersForRevokeByExpert" resultType="long">
        SELECT c.customer_id
        FROM customers c
        JOIN users u ON u.user_id = c.user_id
        JOIN experts me ON me.expert_id = #{expertId}
        WHERE c.customer_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
        AND c.customer_status != '회수'
        AND c.user_id IS NOT NULL
        AND TRIM(me.expert_name) = TRIM(c.customer_source)
        FOR UPDATE
    </select>

    <!-- 회수 실행 -->
    <update id="updateToRevoked">
        UPDATE customers
        SET
        customer_prev_status =
            CASE
                WHEN customer_status IN ('없음','신규','회수') THEN customer_prev_status  -- 없음/신규/회수 상태면 백업하지 않음
                ELSE customer_status         -- 회수 전, 현재상태를 직전상태 칼럼으로 백업
            END,
        customer_status = '회수',
        user_id = NULL,                      -- 회수시 현재 담당자 초기화
--         customer_promise_time = NULL,        -- 회수시 예약 날짜 초기화
--         initial_price = 0,  upsell_price = 0 -- 회수시 최초/업셀 매출값 초기화
        WHERE customer_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
    </update>

    <!-- 매니저 회수(팀장풀로 복귀): 담당자=팀장, 상태=없음, 예약=NULL, 매출=0 -->
    <update id="updateToManagerPool">
        UPDATE customers
        SET
        customer_prev_status =
            CASE
                WHEN customer_status IN ('없음','신규','회수') THEN customer_prev_status -- 없음/신규/회수 상태면 백업하지 않음
                ELSE customer_status         -- 회수 전, 현재상태를 직전상태 칼럼으로 백업
            END,
        customer_status       = '없음',
        user_id               = #{managerId}, -- 회수시 팀장풀로
--        customer_promise_time = NULL,             -- 회수시 예약 날짜 초기화
--        initial_price = 0, upsell_price = 0       -- 회수시 최초/업셀 초기화
        WHERE customer_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
    </update>

<!--    &lt;!&ndash; 회수 후 매출 로그 작성 &ndash;&gt;-->
<!--    <insert id="insertRevokeSalesLogs">-->
<!--        INSERT INTO sales_logs (customer_id, sales_type, amount, created_by, action_at)-->
<!--        SELECT-->
<!--        customer_id,-->
<!--        'RESET',-->
<!--        0,-->
<!--        #{userId},-->
<!--        NOW()-->
<!--        FROM customers-->
<!--        WHERE customer_id IN-->
<!--        <foreach collection="ids" item="id" open="(" separator="," close=")">-->
<!--            #{id}-->
<!--        </foreach>-->
<!--        AND (initial_price > 0 OR upsell_price > 0)-->
<!--    </insert>-->

<!--    <delete id="deleteSchedulesByCustomerIds">-->
<!--        DELETE FROM visit_schedule-->
<!--        WHERE customer_id IN-->
<!--        <foreach collection="ids" item="id" open="(" separator="," close=")">-->
<!--            #{id}-->
<!--        </foreach>-->
<!--    </delete>-->

</mapper>
