<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blue.customer.center.mapper.CustomerCenterMapper">

    <!-- =========================
         findUserContextByEmail
    ========================= -->
    <select id="findUserContextByEmail" resultType="com.blue.customer.all.dto.UserContextDto">
        SELECT
            u.user_id              AS userId,
            u.user_role            AS role,
            u.center_id            AS centerId,
            u.user_email           AS email,
            u.manager_phone_access AS visible
        FROM users u
        WHERE u.user_email = #{email}
        LIMIT 1
    </select>

    <!-- =========================
         findExpertIdByUserId
    ========================= -->
    <select id="findExpertIdByUserId" resultType="long">
        SELECT expert_id
        FROM users
        WHERE user_id = #{userId}
    </select>

    <!-- =========================
         findBranchesExcludingHQ
    ========================= -->
    <select id="findBranchesExcludingHQ" resultType="com.blue.customer.center.dto.BranchSimpleDto">
        SELECT
            b.branch_id   AS branchId,
            b.branch_name AS branchName
        FROM branches b
        WHERE b.branch_id &lt;&gt; 1
        ORDER BY b.branch_id ASC
    </select>

    <!-- =========================
         findCentersByBranchId
    ========================= -->
    <select id="findCentersByBranchId" resultType="com.blue.customer.center.dto.CenterSimpleDto">
        SELECT
            c.center_id   AS centerId,
            c.center_name AS centerName
        FROM centers c
        WHERE c.center_id &lt;&gt; 1
          AND c.branch_id = #{branchId}
        ORDER BY c.center_id ASC
    </select>

    <!-- =========================
         CENTER_DB_FILTERS
    ========================= -->
    <sql id="CENTER_DB_FILTERS">
        <if test="keyword != null and keyword != ''">
            <choose>
                <when test='visible == "N"'>
                    AND (
                    t.name LIKE CONCAT('%', #{keyword}, '%')
                    OR t.staff LIKE CONCAT('%', #{keyword}, '%')
                    OR RIGHT(REGEXP_REPLACE(t.phone, '[^0-9]', ''), 4)
                    = REGEXP_REPLACE(#{keyword}, '[^0-9]', '')
                    OR SUBSTRING(REGEXP_REPLACE(t.phone, '[^0-9]', ''), 1, 3)
                    = REGEXP_REPLACE(#{keyword}, '[^0-9]', '')
                    OR SUBSTRING(REGEXP_REPLACE(t.phone, '[^0-9]', ''), 1, 2)
                    = REGEXP_REPLACE(#{keyword}, '[^0-9]', '')
                    )
                </when>
                <otherwise>
                    AND (
                    t.name    LIKE CONCAT('%', #{keyword}, '%')
                    OR t.staff   LIKE CONCAT('%', #{keyword}, '%')
                    OR t.phone   LIKE CONCAT('%', #{keyword}, '%')
                    OR t.source  LIKE CONCAT('%', #{keyword}, '%')
                    OR t.content LIKE CONCAT('%', #{keyword}, '%')
                    OR t.memo    LIKE CONCAT('%', #{keyword}, '%')
                    )
                </otherwise>
            </choose>
        </if>

        <if test="category != null and category != ''">
            AND t.category = #{category}
        </if>

        <if test="division != null and division != ''">
            AND t.division = #{division}
        </if>

        <if test="expertName != null and expertName != ''">
            AND t.source = #{expertName}
        </if>

        <if test="status != null and status != ''">
            <choose>
                <when test="status == '모든 부재'">
                    AND t.status IN ('부재1','부재2','부재3','부재4','부재5')
                </when>
                <otherwise>
                    AND t.status = #{status}
                </otherwise>
            </choose>
        </if>

        <if test="branchId != null">
            AND t.branchId = #{branchId}
        </if>

        <if test="centerId != null">
            AND t.centerId = #{centerId}
        </if>
    </sql>

    <!-- =========================
         CENTER_DB_FILTERS_EXPERT
    ========================= -->
    <sql id="CENTER_DB_FILTERS_EXPERT">
        <if test="keyword != null and keyword != ''">
            <choose>
                <when test='visible == "N"'>
                    AND (
                    t.name LIKE CONCAT('%', #{keyword}, '%')
                    OR t.staff LIKE CONCAT('%', #{keyword}, '%')
                    OR RIGHT(REGEXP_REPLACE(t.phone, '[^0-9]', ''), 4)
                    = REGEXP_REPLACE(#{keyword}, '[^0-9]', '')
                    OR SUBSTRING(REGEXP_REPLACE(t.phone, '[^0-9]', ''), 1, 3)
                    = REGEXP_REPLACE(#{keyword}, '[^0-9]', '')
                    OR SUBSTRING(REGEXP_REPLACE(t.phone, '[^0-9]', ''), 1, 2)
                    = REGEXP_REPLACE(#{keyword}, '[^0-9]', '')
                    )
                </when>
                <otherwise>
                    AND (
                    t.name    LIKE CONCAT('%', #{keyword}, '%')
                    OR t.staff   LIKE CONCAT('%', #{keyword}, '%')
                    OR t.phone   LIKE CONCAT('%', #{keyword}, '%')
                    OR t.source  LIKE CONCAT('%', #{keyword}, '%')
                    OR t.content LIKE CONCAT('%', #{keyword}, '%')
                    OR t.memo    LIKE CONCAT('%', #{keyword}, '%')
                    )
                </otherwise>
            </choose>
        </if>

        <if test="category != null and category != ''">
            AND t.category = #{category}
        </if>

        <if test="division != null and division != ''">
            AND t.division = #{division}
        </if>

        <if test="status != null and status != ''">
            <choose>
                <when test="status == '모든 부재'">
                    AND t.status IN ('부재1','부재2','부재3','부재4','부재5')
                </when>
                <otherwise>
                    AND t.status = #{status}
                </otherwise>
            </choose>
        </if>

        <if test="branchId != null">
            AND t.branchId = #{branchId}
        </if>

        <if test="centerId != null">
            AND t.centerId = #{centerId}
        </if>
    </sql>

    <!-- =========================
         CENTER_DB_ORDER
    ========================= -->
    <sql id="CENTER_DB_ORDER">
        <bind name="hasStatus"   value="sort != null and sort.contains('status')" />
        <bind name="hasDivision" value="sort != null and sort.contains('division')" />
        <bind name="isRecall"    value="status != null and status.equals('재콜')" />
        <bind name="isOldest"    value="sort != null and sort.contains('oldest')" />

        <choose>
            <when test="isRecall">
                ORDER BY
                (t.promiseAt IS NULL) ASC,
                t.promiseAt ASC
            </when>

            <when test="hasDivision and hasStatus">
                ORDER BY
                FIELD(t.division, '최초','유효','중복'),
                FIELD(t.status,
                '부재1','부재2','부재3','부재4','부재5','기타','결번',
                '재콜','신규','가망','자연풀','카피','거절','없음','회수'),
                CASE WHEN t.status='재콜' THEN (t.promiseAt IS NULL) END ASC,
                CASE WHEN t.status='재콜' THEN t.promiseAt END ASC,
                CASE WHEN t.status&lt;&gt;'재콜' THEN t.createdAt END
                <choose>
                    <when test="isOldest"> ASC</when>
                    <otherwise> DESC</otherwise>
                </choose>
            </when>

            <when test="hasStatus">
                ORDER BY
                FIELD(t.status,
                '부재1','부재2','부재3','부재4','부재5','기타','결번',
                '재콜','신규','가망','자연풀','카피','거절','없음','회수'),
                CASE WHEN t.status='재콜' THEN (t.promiseAt IS NULL) END ASC,
                CASE WHEN t.status='재콜' THEN t.promiseAt END ASC,
                CASE WHEN t.status&lt;&gt;'재콜' THEN t.createdAt END
                <choose>
                    <when test="isOldest"> ASC</when>
                    <otherwise> DESC</otherwise>
                </choose>
            </when>

            <when test="hasDivision">
                ORDER BY
                FIELD(t.division, '최초','유효','중복'),
                t.createdAt
                <choose>
                    <when test="isOldest"> ASC</when>
                    <otherwise> DESC</otherwise>
                </choose>
            </when>

            <otherwise>
                ORDER BY t.createdAt
                <choose>
                    <when test="isOldest"> ASC</when>
                    <otherwise> DESC</otherwise>
                </choose>
            </otherwise>
        </choose>
    </sql>

    <!-- =========================
         findForAdmin
         - 분배완료 가드 추가:
           (담당자 role=MANAGER 이면 status!='없음')
    ========================= -->
    <select id="findForAdmin" resultType="com.blue.customer.center.dto.CenterDbRowDto">
        SELECT
        t.id, t.origin, t.createdAt,
        t.branchId, t.branchName, t.centerId, t.centerName,
        t.staff, t.division, t.category,
        t.name, t.phone, t.source, t.content, t.memo,
        t.status, t.reservation,
        t.initialPrice, t.upsellPrice
        FROM (
        SELECT
        c.customer_id          AS id,
        'CUSTOMER'             AS origin,
        c.customer_created_at  AS createdAt,

        ce.branch_id           AS branchId,
        b.branch_name          AS branchName,
        u.center_id            AS centerId,
        ce.center_name         AS centerName,

        u.user_name            AS staff,
        c.customer_division    AS division,
        c.customer_category    AS category,

        c.customer_name        AS name,
        c.customer_phone       AS phone,
        c.customer_source      AS source,
        c.customer_content     AS content,
        c.customer_memo        AS memo,

        c.customer_status       AS status,
        c.customer_promise_time AS promiseAt,
        DATE_FORMAT(c.customer_promise_time, '%c월 %e일 %H:%i') AS reservation,

        c.initial_price        AS initialPrice,
        c.upsell_price         AS upsellPrice
        FROM customers c
        JOIN users u ON u.user_id = c.user_id
        JOIN centers ce ON ce.center_id = u.center_id
        LEFT JOIN branches b ON b.branch_id = ce.branch_id
        WHERE 1=1
        AND u.center_id &lt;&gt; 1
        AND c.user_id IS NOT NULL
        AND u.center_id IS NOT NULL
        AND (u.user_role &lt;&gt; 'MANAGER' OR c.customer_status &lt;&gt; '없음')
        <if test="dateFrom != null and dateFrom != ''">
            AND c.customer_created_at &gt;= #{dateFrom}
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND c.customer_created_at &lt; DATE_ADD(#{dateTo}, INTERVAL 1 DAY)
        </if>
        <if test="division != null and division != '' and division != '중복'">
            AND c.customer_division = #{division}
        </if>
        <if test="expertName != null and expertName != ''">
            AND c.customer_source = #{expertName}
        </if>
        <if test="status != null and status != ''">
            <choose>
                <when test="status == '모든 부재'">
                    AND c.customer_status IN ('부재1','부재2','부재3','부재4','부재5')
                </when>
                <otherwise>
                    AND c.customer_status = #{status}
                </otherwise>
            </choose>
        </if>
        ) t
        WHERE 1=1
        <include refid="CENTER_DB_FILTERS"/>
        <include refid="CENTER_DB_ORDER"/>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- =========================
         countForAdmin
         - 분배완료 가드 동일 적용
    ========================= -->
    <select id="countForAdmin" resultType="int">
        SELECT COUNT(*)
        FROM (
        SELECT
        c.customer_id          AS id,
        'CUSTOMER'             AS origin,
        c.customer_created_at  AS createdAt,

        ce.branch_id           AS branchId,
        b.branch_name          AS branchName,
        u.center_id            AS centerId,
        ce.center_name         AS centerName,

        u.user_name            AS staff,
        c.customer_division    AS division,
        c.customer_category    AS category,

        c.customer_name        AS name,
        c.customer_phone       AS phone,
        c.customer_source      AS source,
        c.customer_content     AS content,
        c.customer_memo        AS memo,

        c.customer_status       AS status,
        c.customer_promise_time AS promiseAt
        FROM customers c
        JOIN users u ON u.user_id = c.user_id
        JOIN centers ce ON ce.center_id = u.center_id
        LEFT JOIN branches b ON b.branch_id = ce.branch_id
        WHERE 1=1
        AND u.center_id &lt;&gt; 1
        AND c.user_id IS NOT NULL
        AND u.center_id IS NOT NULL
        AND (u.user_role &lt;&gt; 'MANAGER' OR c.customer_status &lt;&gt; '없음')
        <if test="dateFrom != null and dateFrom != ''">
            AND c.customer_created_at &gt;= #{dateFrom}
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND c.customer_created_at &lt; DATE_ADD(#{dateTo}, INTERVAL 1 DAY)
        </if>
        <if test="division != null and division != '' and division != '중복'">
            AND c.customer_division = #{division}
        </if>
        <if test="expertName != null and expertName != ''">
            AND c.customer_source = #{expertName}
        </if>
        <if test="status != null and status != ''">
            <choose>
                <when test="status == '모든 부재'">
                    AND c.customer_status IN ('부재1','부재2','부재3','부재4','부재5')
                </when>
                <otherwise>
                    AND c.customer_status = #{status}
                </otherwise>
            </choose>
        </if>
        ) t
        WHERE 1=1
        <include refid="CENTER_DB_FILTERS"/>
    </select>

    <!-- =========================
     CENTER_EXPERT_NAME_LIST
     - 센터장(본인) + 센터 소속 EXPERT 계정의 expert_id -> experts.expert_name
========================= -->
    <sql id="CENTER_EXPERT_NAME_LIST">
        SELECT e.expert_name
        FROM experts e
                 JOIN users ux ON ux.expert_id = e.expert_id
        WHERE ux.center_id = #{myCenterId}
          AND ux.expert_id IS NOT NULL
          AND ux.user_role IN ('CENTERHEAD','EXPERT')
    </sql>

    <!-- =========================
         findForCenterHead
         - 분배완료 가드 동일 적용(팀장만 status!='없음')
    ========================= -->
    <select id="findForCenterHead" resultType="com.blue.customer.center.dto.CenterDbRowDto">
        SELECT
        t.id, t.origin, t.createdAt,
        t.branchId, t.branchName, t.centerId, t.centerName,
        t.staff, t.division, t.category,
        t.name, t.phone, t.source, t.content, t.memo,
        t.status, t.reservation,
        t.initialPrice, t.upsellPrice
        FROM (
        SELECT
        c.customer_id         AS id,
        'CUSTOMER'            AS origin,
        c.customer_created_at AS createdAt,

        ce.branch_id        AS branchId,
        b.branch_name       AS branchName,
        ce.center_id        AS centerId,
        ce.center_name      AS centerName,

        u.user_name           AS staff,
        c.customer_division   AS division,
        c.customer_category   AS category,

        c.customer_name       AS name,
        c.customer_phone      AS phone,
        c.customer_source     AS source,
        c.customer_content    AS content,
        c.customer_memo       AS memo,

        c.customer_status       AS status,
        c.customer_promise_time AS promiseAt,
        DATE_FORMAT(c.customer_promise_time, '%c월 %e일 %H:%i') AS reservation,

        c.initial_price       AS initialPrice,
        c.upsell_price        AS upsellPrice
        FROM customers c
        LEFT JOIN users u ON u.user_id = c.user_id
        LEFT JOIN centers ce ON ce.center_id = u.center_id
        LEFT JOIN branches b ON b.branch_id = ce.branch_id
        WHERE 1=1
        AND (
        (c.user_id IS NOT NULL AND u.user_id IS NOT NULL AND u.center_id = #{myCenterId})
        OR
        (c.user_id IS NOT NULL AND u.user_id IS NOT NULL
        AND c.customer_source IN (
        <include refid="CENTER_EXPERT_NAME_LIST"/>
        )
        )
        )
        AND (
        IFNULL(u.user_role,'') &lt;&gt; 'MANAGER'
        OR (c.customer_status IS NOT NULL AND c.customer_status &lt;&gt; '' AND c.customer_status &lt;&gt; '없음')
        )

        <if test="dateFrom != null and dateFrom != ''">
            AND c.customer_created_at &gt;= #{dateFrom}
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND c.customer_created_at &lt; DATE_ADD(#{dateTo}, INTERVAL 1 DAY)
        </if>
        <if test="division != null and division != '' and division != '중복'">
            AND c.customer_division = #{division}
        </if>
        <if test="expertName != null and expertName != ''">
            AND c.customer_source = #{expertName}
        </if>
        <if test="status != null and status != ''">
            <choose>
                <when test="status == '모든 부재'">
                    AND c.customer_status IN ('부재1','부재2','부재3','부재4','부재5')
                </when>
                <otherwise>
                    AND c.customer_status = #{status}
                </otherwise>
            </choose>
        </if>
        ) t
        WHERE 1=1
        <include refid="CENTER_DB_FILTERS"/>
        <include refid="CENTER_DB_ORDER"/>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- =========================
         countForCenterHead
         - 분배완료 가드 동일 적용
    ========================= -->
    <select id="countForCenterHead" resultType="int">
        SELECT COUNT(*)
        FROM (
        SELECT
        c.customer_id           AS id,
        ceMy.center_id          AS centerId,
        c.customer_name         AS name,
        c.customer_phone        AS phone,
        c.customer_source       AS source,
        c.customer_status       AS status,
        c.customer_created_at   AS createdAt,
        c.customer_promise_time AS promiseAt,
        u.user_name             AS staff,
        c.customer_division     AS division,
        c.customer_category     AS category,
        c.customer_content      AS content,
        c.customer_memo         AS memo,
        ceMy.branch_id          AS branchId
        FROM customers c
        LEFT JOIN users u ON u.user_id = c.user_id
        JOIN centers ceMy ON ceMy.center_id = #{myCenterId}
        WHERE 1=1
        AND (
        (c.user_id IS NOT NULL AND u.user_id IS NOT NULL AND u.center_id = #{myCenterId})
        OR
        (c.user_id IS NOT NULL AND u.user_id IS NOT NULL
        AND c.customer_source IN (
        <include refid="CENTER_EXPERT_NAME_LIST"/>
        )
        )
        )
        AND (
        IFNULL(u.user_role,'') &lt;&gt; 'MANAGER'
        OR (c.customer_status IS NOT NULL AND c.customer_status &lt;&gt; '' AND c.customer_status &lt;&gt; '없음')
        )

        <if test="dateFrom != null and dateFrom != ''">
            AND c.customer_created_at &gt;= #{dateFrom}
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND c.customer_created_at &lt; DATE_ADD(#{dateTo}, INTERVAL 1 DAY)
        </if>
        <if test="division != null and division != '' and division != '중복'">
            AND c.customer_division = #{division}
        </if>
        <if test="expertName != null and expertName != ''">
            AND c.customer_source = #{expertName}
        </if>
        <if test="status != null and status != ''">
            <choose>
                <when test="status == '모든 부재'">
                    AND c.customer_status IN ('부재1','부재2','부재3','부재4','부재5')
                </when>
                <otherwise>
                    AND c.customer_status = #{status}
                </otherwise>
            </choose>
        </if>
        ) t
        WHERE 1=1
        <include refid="CENTER_DB_FILTERS"/>
    </select>

    <!-- =========================
         findForExpert
         - "분배완료된 DB만"이면 user_id(담당자) 존재가 기본
         - 팀장 담당이면 status!='없음' 가드 추가
    ========================= -->
    <select id="findForExpert" resultType="com.blue.customer.center.dto.CenterDbRowDto">
        SELECT
        t.id, t.origin, t.createdAt,
        t.branchId, t.branchName, t.centerId, t.centerName,
        t.staff, t.division, t.category,
        t.name, t.phone, t.source, t.content, t.memo,
        t.status, t.reservation,
        t.initialPrice, t.upsellPrice
        FROM (
        SELECT
        c.customer_id          AS id,
        'CUSTOMER'             AS origin,
        c.customer_created_at  AS createdAt,

        ce.branch_id           AS branchId,
        b.branch_name          AS branchName,
        u.center_id            AS centerId,
        ce.center_name         AS centerName,

        u.user_name            AS staff,
        c.customer_division    AS division,
        c.customer_category    AS category,

        c.customer_name        AS name,
        c.customer_phone       AS phone,
        c.customer_source      AS source,
        c.customer_content     AS content,
        c.customer_memo        AS memo,

        c.customer_status       AS status,
        c.customer_promise_time AS promiseAt,
        DATE_FORMAT(c.customer_promise_time, '%c월 %e일 %H:%i') AS reservation,

        c.initial_price        AS initialPrice,
        c.upsell_price         AS upsellPrice
        FROM customers c
        JOIN users u ON u.user_id = c.user_id
        JOIN centers ce ON ce.center_id = u.center_id
        LEFT JOIN branches b ON b.branch_id = ce.branch_id
        WHERE 1=1
        AND u.center_id &lt;&gt; 1
        AND c.user_id IS NOT NULL
        AND u.center_id IS NOT NULL
        AND c.customer_source = (SELECT expert_name FROM experts WHERE expert_id = #{myExpertId})
        AND (u.user_role &lt;&gt; 'MANAGER' OR c.customer_status &lt;&gt; '없음')
        <if test="dateFrom != null and dateFrom != ''">
            AND c.customer_created_at &gt;= #{dateFrom}
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND c.customer_created_at &lt; DATE_ADD(#{dateTo}, INTERVAL 1 DAY)
        </if>
        <if test="division != null and division != '' and division != '중복'">
            AND c.customer_division = #{division}
        </if>
        <if test="status != null and status != ''">
            <choose>
                <when test="status == '모든 부재'">
                    AND c.customer_status IN ('부재1','부재2','부재3','부재4','부재5')
                </when>
                <otherwise>
                    AND c.customer_status = #{status}
                </otherwise>
            </choose>
        </if>
        ) t
        WHERE 1=1
        <include refid="CENTER_DB_FILTERS_EXPERT"/>
        <include refid="CENTER_DB_ORDER"/>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- =========================
         countForExpert
         - findForExpert와 동일 조건
    ========================= -->
    <select id="countForExpert" resultType="int">
        SELECT COUNT(*)
        FROM (
        SELECT
        c.customer_id          AS id,
        'CUSTOMER'             AS origin,
        c.customer_created_at  AS createdAt,

        ce.branch_id           AS branchId,
        b.branch_name          AS branchName,
        u.center_id            AS centerId,
        ce.center_name         AS centerName,

        u.user_name            AS staff,
        c.customer_division    AS division,
        c.customer_category    AS category,

        c.customer_name        AS name,
        c.customer_phone       AS phone,
        c.customer_source      AS source,
        c.customer_content     AS content,
        c.customer_memo        AS memo,

        c.customer_status       AS status,
        c.customer_promise_time AS promiseAt
        FROM customers c
        JOIN users u ON u.user_id = c.user_id
        JOIN centers ce ON ce.center_id = u.center_id
        LEFT JOIN branches b ON b.branch_id = ce.branch_id
        WHERE 1=1
        AND u.center_id &lt;&gt; 1
        AND c.user_id IS NOT NULL
        AND u.center_id IS NOT NULL
        AND c.customer_source = (SELECT expert_name FROM experts WHERE expert_id = #{myExpertId})
        AND (u.user_role &lt;&gt; 'MANAGER' OR c.customer_status &lt;&gt; '없음')
        <if test="dateFrom != null and dateFrom != ''">
            AND c.customer_created_at &gt;= #{dateFrom}
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND c.customer_created_at &lt; DATE_ADD(#{dateTo}, INTERVAL 1 DAY)
        </if>
        <if test="division != null and division != '' and division != '중복'">
            AND c.customer_division = #{division}
        </if>
        <if test="status != null and status != ''">
            <choose>
                <when test="status == '모든 부재'">
                    AND c.customer_status IN ('부재1','부재2','부재3','부재4','부재5')
                </when>
                <otherwise>
                    AND c.customer_status = #{status}
                </otherwise>
            </choose>
        </if>
        ) t
        WHERE 1=1
        <include refid="CENTER_DB_FILTERS_EXPERT"/>
    </select>

</mapper>
